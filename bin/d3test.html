<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script src="../js/jquery.min.js"></script>
<script src="../js/d3.v3.min.js"></script>
<script src="../js/public.js"></script>
<style type="text/css">
.axis path, .axis line {
	fill: none;
	stroke: #000;
	shape-rendering: crispEdges;
}
.axis text {
	color: #fff;
}
</style>
<div id="view" style="width:900px; height:400px; margin:50px">
</script> 
<script language="javascript">
	function getData(){
		var names = getNames(20), units = ['现金管理部', '营销管理部', '投资银行部', '企业业务部', '风险管理部', '金融市场部', '机构业务部'],
			moneyP = [0.3, 0.9, 0.6, 0.5, 1, 0.4, 0.25];
		var ls = names.map(function(d){
			var u = parseInt(Math.random() * units.length), p = Math.random(), pv=Math.random();
			return { name:d, unit:units[u], money:parseInt(Math.random()*6000 + 6000 * moneyP[u]),
				score:parseInt(Math.random()* 75 + 25), year:p>0.3 ? parseInt(pv*5 + 1): parseInt(pv*10 + 1) };
		});
		var x=0, y=0, r=0;
		ls.forEach(function(d){
			x = d.score < x ? x : d.score, y = d.money < y ? y : d.money, r = d.year < r ? r : d.year;
		});
		return { data:ls, maxX:x, maxY:y, maxR:r };
	}
	
	LoadScaff('view', getData());
	
	var Dates=[];
	var Sum=0;
	
	//判断矩形相交	 true:相交	console.log(cross([100,100,150,150], [151,125,300,300]));
	function cross(rt1, rt2){
		var minx = Math.max(rt1[0], rt2[0]), miny = Math.max(rt1[1], rt2[1]), 
				maxx = Math.min(rt1[2], rt2[2]), maxy = Math.min(rt1[3], rt2[3]);
		return (minx > maxx) || (miny > maxy) ? false : true; 
	};
	function LoadScaff(id, source){
		var div=d3.select("#"+id), w=parseInt(div.style("width")), h=parseInt(div.style("height"));
		var lsRect = [];
		
		//检测是否与已有标签冲突		true:冲突
		var rect = function(d, t){ 
			var rt = [xScale(d.score)- t.width/2, yScale(d.money)-t.height/2, 
					xScale(d.score)+ t.width/2, yScale(d.money)+t.height/2], i, l = lsRect.length;
			for(i=0; i<lsRect.length; i++)if(cross(lsRect[i], rt))break;
			if(i==lsRect.length)lsRect.push(rt);
			return (i==l) ? false : true ;
		};
		var margin = {top: 29.5, right: 29.5, bottom: 29.5, left: 49.5},
			width = w - margin.right, height = h - margin.top - margin.bottom;
		var xScale = d3.scale.linear().domain([0, source.maxX+10]).range([0, width]),
			yScale = d3.scale.linear().domain([-10, source.maxY+1000]).range([height, 0]),
			radiusScale = d3.scale.sqrt().domain([0, source.maxR]).range([0, 30]),
			colorScale = d3.scale.category10();
		var xAxis = d3.svg.axis().scale(xScale).orient("bottom").ticks(10, d3.format(",d")),
			yAxis = d3.svg.axis().scale(yScale).orient("left").ticks(5);
		var svg = d3.select("#"+id).append("svg")
			.attr("width", width + margin.left + margin.right)
			.attr("height", height + margin.top + margin.bottom)
			.append("g")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
			
		svg.append("g").attr("class", "x axis")
			.attr("transform", "translate(0," + height + ")")
			.call(xAxis);
		svg.append("g").attr("class", "y axis").call(yAxis);
		
		svg.append("text")
			.attr("class", "x label").attr("text-anchor", "end")
			.attr("x", width).attr("y", height - 6)
			.text("绩效");
		svg.append("text")
			.attr("class", "y label").attr("text-anchor", "end")
			.attr("y", 6).attr("dy", ".75em").attr("transform", "rotate(-90)")
			.text("薪资");
		var avgr = source.data.reduce(function(a, b){ return a + b.year; }, 0)/source.data.length;
		
		var dot = svg.append("g")
		  	.selectAll(".dot")
			.attr("class", "dot")
			.data(source.data)
		  	.enter().append("circle")
			.attr("cx", function(d) { return xScale(d.score); })
			.attr("cy", function(d) { return yScale(d.money); })
			.attr("r", function(d) { return radiusScale(d.year); })
			.style("fill", function(d) { return colorScale(d.year); })
			.sort(order);
		dot.append("title").text(function(d) { 
			return d.name+' [' + d.unit + '], 月薪：'+d.money+',  绩效：'+d.score+',  从业年限：'+d.year + '年'; 
		});	
		
		var txt = svg.append("g").selectAll("text").data(source.data).enter().sort(order)
			.append("text")
      		.attr("dy", ".40em")
			.style("font-size", "12px")
      		.attr("text-anchor", "middle")
      		.text(function(d) { return d.name; }) //d.year > (avgr*0.8) ? d.name : ''; 
			.attr('transform', function(d, i){
				var f = rect(d, this.getBBox()); //检测相交
				return "translate(" + (f ? -100 : xScale(d.score)) + "," + (f ? -100 : yScale(d.money)) + ")";
			});
		dot.append("title").text(function(d) { 
			return d.name+' [' + d.unit + '], 月薪：'+d.money+',  绩效：'+d.score+',  从业年限：'+d.year + '年'; 
		});	
		
		function order(a, b) { return b.year - a.year; }
	}

</script>