<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script src="../js/jquery.min.js"></script>
<script src="../js/d3.v3.min.js"></script>
<script src="../js/public.js"></script>
<style type="text/css">
.axis path, .axis line {
	fill: none;
	stroke: #000;
	shape-rendering: crispEdges;
}
.axis text {
	color: #fff;
}
</style>
<div id="view" style="width:1000px; height:400px; margin:50px; border:0px solid #ccc; "></div>

</script> 
<script language="javascript">
	function getData(){
		var names = getNames(20), units = ['现金管理部', '营销管理部', '投资银行部', '企业业务部', '风险管理部', '金融市场部', '机构业务部'],
			moneyP = [0.3, 0.9, 0.6, 0.5, 1, 0.4, 0.25];
		var ls = names.map(function(d){
			var u = parseInt(Math.random() * units.length), p = Math.random(), pv=Math.random();
			return { name:d, unit:units[u], money:parseInt(Math.random()*6000 + 6000 * moneyP[u]),
				score:parseInt(Math.random()* 75 + 25), year:p>0.3 ? parseInt(pv*5 + 1): parseInt(pv*10 + 1) };
		});
		var x=0, y=0, r=0;
		ls.forEach(function(d){
			x = d.money < x ? x : d.money, y = d.score < y ? y : d.score, r = d.year < r ? r : d.year;
		});
		return { data:ls, maxX:x, maxY:y, maxR:r };
	}

	LoadScaff('view', getData());
	
	//判断矩形相交	 true:相交	console.log(cross([100,100,150,150], [151,125,300,300]));
	function Unicode(str) { return escape(str).replace(/%u/gi, ''); };  
	function cross(rt1, rt2){
		var minx = Math.max(rt1[0], rt2[0]), miny = Math.max(rt1[1], rt2[1]), 
				maxx = Math.min(rt1[2], rt2[2]), maxy = Math.min(rt1[3], rt2[3]);
		return (minx > maxx) || (miny > maxy) ? false : true; 
	};
	function LoadScaff(id, source){
		var div=d3.select("#"+id), desp_width = 130,
			w=parseInt(div.style("width")), h=parseInt(div.style("height"));
		var lsRect = [];
		
		//检测是否与已有标签冲突		true:冲突
		function rect(d, t){ 
			var rt = [xScale(d.score)- t.width/2, yScale(d.money)-t.height/2, 
					xScale(d.score)+ t.width/2, yScale(d.money)+t.height/2], i, l = lsRect.length;
			for(i=0; i<lsRect.length; i++)if(cross(lsRect[i], rt))break;
			if(i==lsRect.length)lsRect.push(rt);
			return (i==l) ? false : true ;
		};
		function order(a, b) { return b.year - a.year; }
		
		var margin = {top: 29.5, right: 29.5, bottom: 29.5, left: 52.5},
			width = w - margin.right, height = h - margin.top - margin.bottom, cwidth = w-desp_width-margin.left;
		var xScale = d3.scale.linear().domain([0, source.maxX+1000]).range([0, cwidth]),
			yScale = d3.scale.linear().domain([-10, source.maxY+10]).range([height, 0]),
			radiusScale = d3.scale.sqrt().domain([0, source.maxR]).range([0, 30]),
			colorScale = d3.scale.category10();
		var xAxis = d3.svg.axis().scale(xScale).orient("bottom").ticks(10, d3.format(",d")),
			yAxis = d3.svg.axis().scale(yScale).orient("left").ticks(5);
		var svg = d3.select("#"+id).append("svg")
			.attr("width", w).attr("height", h)
			.append("g")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
		
		var desp = svg.append("g").attr("transform", "translate(" + (cwidth + 5) + "," + 0 + ")")
			.append("g").attr('width', desp_width).attr('height', h).style('fill', 'green');
		
		addDesp(desp, [], colorScale, radiusScale, source.data);
		
		svg.append("g").attr("class", "x axis").attr("transform", "translate(0," + height + ")").call(xAxis);
		svg.append("g").attr("class", "y axis").call(yAxis);
		
		svg.append("text")
			.attr("class", "x label").attr("text-anchor", "end")
			.attr("x", cwidth).attr("y", height - 6)
			.text("薪资");
		svg.append("text")
			.attr("class", "y label").attr("text-anchor", "end")
			.attr("y", 6).attr("dy", ".75em").attr("transform", "rotate(-90)")
			.text("绩效");
		var avgr = source.data.reduce(function(a, b){ return a + b.year; }, 0)/source.data.length;

		var dot = svg.append("g")
		  	.selectAll(".dot")
			.attr("class", "dot")
			.data(source.data)
		  	.enter().append("circle")
			.attr("cx", function(d) { return xScale(d.money); })
			.attr("cy", function(d) { return yScale(d.score); })
			.attr("id", function(d) { return 'rect' + Unicode(d.unit + 'p' + d.name); })
			.style('cursor', 'pointer')
			.attr("r", function(d) { return radiusScale(d.year); })
			.style("fill", function(d) { return colorScale(d.unit); })
			.sort(order);
		
		var txt = svg.append("g").selectAll("text").data(source.data).enter().sort(order)
			.append("text")
      		.attr("dy", ".40em")
			.style("font-size", "12px")
      		.attr("text-anchor", "middle")
			.attr("id", function(d) { return 'text' + Unicode(d.unit + 'p' + d.name); })
			.style('cursor', 'pointer')
      		.text(function(d) { return d.year > (avgr*0.8) ? d.name : ''; })
			.attr('transform', function(d, i){
				var f = rect(d, this.getBBox()); //检测相交
				return "translate(" + (f ? -100 : xScale(d.money)) + "," + (f ? -100 : yScale(d.score)) + ")";
			});
		addTooltip(dot);
		addTooltip(txt);
		/*
		txt.append("title").text(function(d) { 
			return d.name+' [' + d.unit + '], 月薪：'+d.money+',  绩效：'+d.score+',  从业年限：'+d.year + '年'; 
		});			
		dot.append("title").text(function(d) { 
			return d.name+' [' + d.unit + '], 月薪：'+d.money+',  绩效：'+d.score+',  从业年限：'+d.year + '年'; 
		});	
		*/
	}
	//事件
	function addEvents(){
		
	}
	//提示框  Tooltip
	function addTooltip(svg){
		var tooltip = d3.select("body").append("div")
			.style('position', 'absolute').style('width', 120).style('height', 'auto')
			.style('font-family', 'simsun').style('font-size', '14px').style('text-align', 'left')
			.style('border-style', 'solid').style('border-width', '1px').style('background-color', 'white')
			.style('border-radius', '5px').style("opacity",0.0);
		svg.on("mouseover", function(d){
			console.log('OK');
			tooltip.html(d.name + "<br />部门：" + d.unit + "<br />月薪：<span style='color:red'>" + d.money + '</span>'
				+ "<br />绩效：" + d.score + "<br />从业年限：" + d.year )
            .style("left", (d3.event.pageX) + "px").style("top", (d3.event.pageY + 20) + "px")
            .style("opacity",1.0);
		})
		.on("mousemove", function(d){
	    	tooltip.style("left", (d3.event.pageX) + "px").style("top", (d3.event.pageY + 20) + "px");
		})
		.on("mouseout", function(d){ tooltip.style("opacity",0.0); });
	}
	//说明 lengend
	function addDesp(svg, units, color, radius, data){
		units = ['现金管理部', '营销管理部', '投资银行部', '企业业务部', '风险管理部', '金融市场部', '机构业务部'];
		var p_top = 20, p_left = 20;
		var group = svg.append('g').selectAll("g").data(units).enter().append("g")
			.style("fill",function(d, i){ return color(d); })
			
		group.append('rect').attr('width', 23).attr('height', 13).attr('x', p_left)
			.attr('y', function(d, i){ return (13 + 10) * i + p_top; })
			.attr('rx', 4).attr('ry', 4)
			.attr('id', function(d, i){ return 'lg' + i; })
			.style('cursor', 'pointer')
			.attr('id', function(d, i){ return 'lged' + i; })
			.on('click', legend);
			
		group.append('text').style('font-size', '12px')
			.text(function(d){ return d; }).attr('x', 30 + p_left)
			.attr('y', function(d, i){ var h = this.getBBox().height; return (13 + 10) * i + h-2 + p_top; })
			.style('cursor', 'pointer')
			.attr('id', function(d, i){ return 'desp' + i; })
			.on('click', legend);
		
		var posTop = (13 + 10) * units.length + p_top + 15, pos=posTop, r = 0;
		data.forEach(function(d){ r = d.year < r ? r : d.year; });
		var sizes = [0.5, 1, 2, 3];
		/*
		var g2 = svg.selectAll("circle").data(sizes).enter().append("g")
			.attr("transform", "translate(" + 10 + "," + 10 + ")")	
			.append('circle')
			.attr('cy', function(d, i){ var t = posTop; posTop += (4+radius(d)*2); return t+radius(d); })
			.attr('cx', function(d){ return 10 + radius(sizes[sizes.length-1]); })
			.attr('r', function(d, i){ return radius(d) ; })
		*/
		var g2 = svg.append("g").selectAll("g").data(sizes).enter().append("g")
			//.attr("transform", "translate(" + 10 + "," + 50 + ")");
			
		g2.append('circle')
			.attr('cy', function(d, i){ var t = posTop; posTop += (4+radius(d)*2); return t+radius(d); })
			.attr('cx', function(d){ return 10 + radius(sizes[sizes.length-1]); })
			.attr('r', function(d, i){ return radius(d) ; })
		g2.append('rect').attr('width', 10 + radius(sizes[sizes.length-1]))
			.attr('height', sizes.reduce(function(a, b){ return a + radius(b)*2 + 4; }, 0))
			.attr("transform", "translate(" + 10 + "," + pos + ")")
			;
		/*
		g2.attr("transform", "translate(" + 10 + "," + 50 + ")")	
			.append('rect')
			.attr('class', 'rect')
			.attr('y', function(d, i){ var t = posTop; posTop += (4+radius(d)*2); return t+radius(d); })
			.attr('x', function(d){ return 10 + radius(sizes[sizes.length-1]); })
			.attr('width', function(d, i){ return radius(d) ; })
			.attr('height', function(d, i){ return radius(d) ; })
		*/
		function legend(d){
			var e = d3.select(this), num = this.id.substr(4), c = 'rgb(205, 205, 205)',
					clr = e.style('fill') == c ? color(d) : c, hide = e.style('fill') == c ? 'block' : 'none' ;
				console.log(parseInt(num));
				var lsP = data.filter(function(c){ return c.unit == d; })
					.map(function(c){ return Unicode(c.unit + 'p' + c.name); });
				lsP.forEach(function(c){ 
					d3.select('#rect' + c).style('display', hide);
					d3.select('#text' + c).style('display', hide);
				});
				d3.select('#lged' + num).style('fill', clr);
				d3.select('#desp' + num).style('fill', clr);
		}
		
	}
	
</script>